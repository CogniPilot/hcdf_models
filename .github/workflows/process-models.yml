name: Process New Models

on:
  push:
    branches: ["main"]
    paths:
      - 'process_request/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process:
    runs-on: ubuntu-latest
    outputs:
      changes: ${{ steps.commit.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process new models and HCDFs
        run: |
          #!/bin/bash
          set -e

          PROCESS_DIR="process_request"
          MODELS_DIR="models"

          # Check if process_request exists and has files (other than .gitkeep)
          HAS_FILES=false
          if [ -d "$PROCESS_DIR" ]; then
            for f in "$PROCESS_DIR"/*; do
              [ -f "$f" ] && [ "$(basename "$f")" != ".gitkeep" ] && HAS_FILES=true && break
            done
          fi

          if [ "$HAS_FILES" = "false" ]; then
            echo "No files to process in $PROCESS_DIR"
            # Still run index.html update in case it's out of sync
          else

          mkdir -p "$MODELS_DIR"

          # Track what we processed
          declare -A PROCESSED_GLBS  # original_name -> sha_prefixed_name
          declare -a HCDF_FILES

          # First pass: Process all GLB files
          echo "=== Processing GLB files ==="
          for glb in "$PROCESS_DIR"/*.glb; do
            [ -f "$glb" ] || continue

            filename=$(basename "$glb")
            echo "Processing: $filename"

            # Compute SHA256
            full_sha=$(sha256sum "$glb" | cut -d' ' -f1)
            short_sha="${full_sha:0:8}"

            # Check if filename already has correct SHA prefix
            if [[ "$filename" =~ ^([a-f0-9]{8})-(.+)$ ]]; then
              existing_sha="${BASH_REMATCH[1]}"
              base_name="${BASH_REMATCH[2]}"

              if [ "$existing_sha" = "$short_sha" ]; then
                echo "  Already has correct SHA prefix: $filename"
                sha_prefixed_name="$filename"
              else
                echo "  Updating SHA prefix: $existing_sha -> $short_sha"
                sha_prefixed_name="${short_sha}-${base_name}"
              fi
            else
              # No SHA prefix, add one
              base_name="$filename"
              sha_prefixed_name="${short_sha}-${filename}"
              echo "  Adding SHA prefix: $sha_prefixed_name"
            fi

            # Store mapping for HCDF updates (both with and without old prefix)
            PROCESSED_GLBS["$filename"]="$sha_prefixed_name"
            PROCESSED_GLBS["$base_name"]="$sha_prefixed_name"

            # Move to models directory
            target="$MODELS_DIR/$sha_prefixed_name"
            if [ -f "$target" ]; then
              echo "  Model already exists: $target (skipping)"
              rm "$glb"
            else
              mv "$glb" "$target"
              echo "  Moved to: $target"
            fi
          done

          # Second pass: Process all HCDF files
          echo ""
          echo "=== Processing HCDF files ==="
          for hcdf in "$PROCESS_DIR"/*.hcdf; do
            [ -f "$hcdf" ] || continue

            filename=$(basename "$hcdf")
            echo "Processing: $filename"

            # Read the HCDF content
            content=$(cat "$hcdf")

            # Update model references
            # Match: href="..." or href='...' containing .glb
            for original in "${!PROCESSED_GLBS[@]}"; do
              sha_prefixed="${PROCESSED_GLBS[$original]}"

              # Extract the full SHA for this model
              full_sha=$(sha256sum "$MODELS_DIR/$sha_prefixed" 2>/dev/null | cut -d' ' -f1 || echo "")

              if [ -n "$full_sha" ]; then
                # Update href to use models/ path with SHA-prefixed name
                # Handle various href formats
                content=$(echo "$content" | sed -E "s|href=\"[^\"]*$original\"|href=\"models/$sha_prefixed\"|g")
                content=$(echo "$content" | sed -E "s|href='[^']*$original'|href='models/$sha_prefixed'|g")

                # Remove any existing sha attribute from model tags with this href
                content=$(echo "$content" | sed -E "s|(<model[^>]*href=\"models/$sha_prefixed\"[^>]*) sha=\"[^\"]*\"|\\1|g")

                # Add sha attribute before the closing /> or >
                content=$(echo "$content" | sed -E "s|(<model[^>]*href=\"models/$sha_prefixed\")(/?>)|\\1 sha=\"$full_sha\"\\2|g")
              fi
            done

            # Determine target directory from HCDF filename
            # Expected format: {board}-{device}.hcdf (e.g., mr_mcxn_t1-optical-flow.hcdf)
            # Extract board name (first part with underscores) and device name (rest with hyphens)
            if [[ "$filename" =~ ^([a-z0-9_]+)-([a-z0-9-]+)\.hcdf$ ]]; then
              board="${BASH_REMATCH[1]}"
              device="${BASH_REMATCH[2]}"
              target_dir="$board/$device"
              target_name="$device.hcdf"
            else
              # Fallback: use filename without extension as device in "unknown" board
              device="${filename%.hcdf}"
              target_dir="unknown/$device"
              target_name="$device.hcdf"
              echo "  Warning: Could not parse board from filename, using 'unknown' board"
            fi

            # Create target directory
            mkdir -p "$target_dir"

            # Compute SHA of the updated HCDF content
            hcdf_sha=$(echo "$content" | sha256sum | cut -c1-8)
            sha_prefixed_hcdf="${hcdf_sha}-${target_name}"

            # Write SHA-prefixed HCDF file
            echo "$content" > "$target_dir/$sha_prefixed_hcdf"
            echo "  Created: $target_dir/$sha_prefixed_hcdf"

            # Create symlink for latest version
            cd "$target_dir"
            rm -f "$target_name"
            ln -s "$sha_prefixed_hcdf" "$target_name"
            cd - > /dev/null
            echo "  Symlink: $target_dir/$target_name -> $sha_prefixed_hcdf"

            # Remove from process_request
            rm "$hcdf"
          done

          # Clean up any remaining files (warn about them)
          remaining=$(ls "$PROCESS_DIR" 2>/dev/null | wc -l)
          if [ "$remaining" -gt 0 ]; then
            echo ""
            echo "=== Warning: Unprocessed files remaining ==="
            ls -la "$PROCESS_DIR"
          fi

          # Remove process_request if empty
          rmdir "$PROCESS_DIR" 2>/dev/null || true

          echo ""
          echo "=== Processing complete ==="

          fi  # End of HAS_FILES block

      - name: Update index.html
        run: |
          #!/bin/bash
          set -e

          # Collect all board/device pairs
          ENTRIES=""
          for hcdf in $(find . -name "*.hcdf" -type f ! -path "./process_request/*" | sort); do
            # Skip symlinks
            [ -L "$hcdf" ] && continue

            dir=$(dirname "$hcdf")
            device=$(basename "$dir")
            board=$(basename "$(dirname "$dir")")

            [ "$board" = "." ] && continue
            [ -z "$board" ] && continue

            ENTRIES="$ENTRIES$board|$device\n"
          done

          # Get unique board/device pairs
          UNIQUE_ENTRIES=$(echo -e "$ENTRIES" | sort -u | grep -v '^$')

          # Collect models
          MODELS=$(ls -1 models/*.glb 2>/dev/null | xargs -I{} basename {} | sort)

          # Generate index.html
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CogniPilot HCDF Models</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
            color: #333;
        }
        h1 { color: #1a1a1a; }
        h2 { color: #444; margin-top: 2rem; }
        .board {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .board h3 { margin-top: 0; color: #2563eb; }
        .files { font-family: monospace; font-size: 0.9rem; }
        .files a { color: #2563eb; text-decoration: none; }
        .files a:hover { text-decoration: underline; }
        code { background: #e5e5e5; padding: 0.2rem 0.4rem; border-radius: 4px; }
        pre { background: #e5e5e5; padding: 1rem; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>CogniPilot HCDF Models</h1>
    <p>
        Hardware Configuration Descriptive Format (HCDF) files and 3D models for CogniPilot hardware.
        These files are used by <a href="https://github.com/CogniPilot/dendrite">Dendrite</a> for 3D visualization.
    </p>

    <h2>Repository Structure</h2>
    <p>
        HCDF files are organized by board and device type, with SHA-prefixed versions for immutability:
    </p>
    <pre>{board}/{device}/{sha}-{device}.hcdf   # SHA-prefixed version (immutable)
{board}/{device}/{device}.hcdf          # Symlink to latest version</pre>
    <p>
        Models are stored in a flat <code>models/</code> directory with SHA-prefixed filenames:
    </p>
    <pre>models/{short_sha}-{name}.glb</pre>

    <h2>Available Boards</h2>
EOF

          # Group by board and add sections
          current_board=""
          for entry in $UNIQUE_ENTRIES; do
            board=$(echo "$entry" | cut -d'|' -f1)
            device=$(echo "$entry" | cut -d'|' -f2)

            if [ "$board" != "$current_board" ]; then
              # Close previous board section if any
              if [ -n "$current_board" ]; then
                echo "            </ul>" >> index.html
                echo "        </div>" >> index.html
                echo "    </div>" >> index.html
              fi

              # Start new board section
              display_name=$(echo "$board" | tr '_' '-' | tr '[:lower:]' '[:upper:]')
              echo "" >> index.html
              echo "    <div class=\"board\">" >> index.html
              echo "        <h3>$display_name</h3>" >> index.html
              echo "        <div class=\"files\">" >> index.html
              echo "            <p><strong>HCDF Fragments:</strong></p>" >> index.html
              echo "            <ul>" >> index.html
              current_board="$board"
            fi

            echo "                <li><a href=\"$board/$device/$device.hcdf\">$device/$device.hcdf</a></li>" >> index.html
          done

          # Close last board section
          if [ -n "$current_board" ]; then
            echo "            </ul>" >> index.html
            echo "        </div>" >> index.html
            echo "    </div>" >> index.html
          fi

          # Add models section
          echo "" >> index.html
          echo "    <h2>Models</h2>" >> index.html
          echo "    <div class=\"board\">" >> index.html
          echo "        <div class=\"files\">" >> index.html
          echo "            <ul>" >> index.html
          for model in $MODELS; do
            echo "                <li><a href=\"models/$model\">$model</a></li>" >> index.html
          done
          echo "            </ul>" >> index.html
          echo "        </div>" >> index.html
          echo "    </div>" >> index.html

          # Add footer
          cat >> index.html << 'EOF'

    <h2>URL Format</h2>
    <p>
        Devices report their HCDF URL via MCUmgr. URL formats:
    </p>
    <pre># Latest version (uses symlink):
https://hcdf.cognipilot.org/{board}/{device}/{device}.hcdf

# Pinned version (immutable):
https://hcdf.cognipilot.org/{board}/{device}/{sha}-{device}.hcdf</pre>
    <p>
        Models are referenced from HCDF files with their SHA-prefixed paths:
    </p>
    <pre>&lt;model href="models/{short_sha}-{name}.glb" sha="{full_sha}"/&gt;</pre>

    <h2>HCDF Schema</h2>
    <p>
        HCDF files follow the <a href="https://github.com/CogniPilot/cps_describe">CPS Describe</a> schema.
        Each fragment defines visuals (3D models) and reference frames for a specific board/application combination.
    </p>

    <footer style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #ddd; color: #666; font-size: 0.9rem;">
        <p>CogniPilot Project - <a href="https://cognipilot.org">cognipilot.org</a></p>
    </footer>
</body>
</html>
EOF

          echo "Updated index.html"

      - name: Commit changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Process new models and HCDFs"
            git push
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: process
    if: needs.process.outputs.changes == 'true'
    uses: ./.github/workflows/pages.yml
    secrets: inherit
